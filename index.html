<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecular Viewer Pro</title>
    <style>
        :root {
            --bg-color: #2C2C2C;
            --surface-color: #3A3A3A;
            --primary-text-color: #E0E0E0;
            --secondary-text-color: #A0A0A0;
            --primary-accent-color: #0D99FF;
            --primary-accent-hover-color: #007BE5;
            --border-color: #4A4A4A;
            --input-bg-color: #252525;
            --canvas-bg-color: #1E1E1E; 
            --danger-color: #FF4D4D;
            --danger-hover-color: #E53E3E;

            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-size-base: 14px;
            --font-size-small: 12px;
            --font-size-large: 18px;
            --border-radius: 6px;
            --padding-base: 10px;
            --padding-large: 15px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--font-size-base);
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            display: flex;
            height: 100vh;
            overflow: hidden; /* Prevent body scrollbars */
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 320px;
            background-color: var(--surface-color);
            padding: var(--padding-large);
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow sidebar to scroll if content overflows */
            border-right: 1px solid var(--border-color);
        }

        .main-content {
            flex-grow: 1;
            padding: 0; /* Canvas will fill this */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--canvas-bg-color); /* Background for the canvas area */
        }

        #canvas {
            border: none; /* Remove previous border */
            /* Width and height are set by JS/WASM, ensure it fits if main-content has padding */
            max-width: 100%;
            max-height: 100%;
        }

        .sidebar h1, .sidebar h2 {
            color: var(--primary-text-color);
            margin-bottom: var(--padding-base);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--padding-base);
        }
        .sidebar h1 { font-size: var(--font-size-large); }
        .sidebar h2 { font-size: 1.1em; margin-top: var(--padding-large); }

        .control-group {
            margin-bottom: var(--padding-large);
        }

        .control-group label {
            display: block;
            font-size: var(--font-size-small);
            color: var(--secondary-text-color);
            margin-bottom: 5px;
        }

        .control-group textarea,
        .control-group input[type="text"], /* If we add text inputs */
        .control-group select /* If we add selects */
        {
            width: 100%;
            background-color: var(--input-bg-color);
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--padding-base);
            font-family: monospace;
            font-size: var(--font-size-small);
        }
        .control-group textarea { min-height: 100px; }

        .control-group button,
        .control-group input[type="file"]::file-selector-button {
            background-color: var(--primary-accent-color);
            color: white;
            border: none;
            padding: var(--padding-base) var(--padding-large);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: var(--font-size-base);
            transition: background-color 0.2s ease;
            width: 100%;
            margin-top: 5px;
        }

        .control-group button:hover,
        .control-group input[type="file"]::file-selector-button:hover {
            background-color: var(--primary-accent-hover-color);
        }
        
        /* Styling for the actual file input to make it look like a button */
        .control-group input[type="file"] {
            color: transparent; /* Hide default text */
        }
        .control-group input[type="file"]::-webkit-file-upload-button {
             visibility: hidden; /* Hide default button in chrome/safari */
        }
         .control-group input[type="file"]::before {
            content: 'Load from .xyz File'; /* Custom button text */
            display: inline-block;
            background-color: var(--primary-accent-color);
            color: white;
            border: none;
            padding: var(--padding-base) var(--padding-large);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: var(--font-size-base);
            transition: background-color 0.2s ease;
            text-align: center;
            width: calc(100% - 30px); /* Adjust width as needed if padding makes it too wide */
        }
        .control-group input[type="file"]:hover::before {
            background-color: var(--primary-accent-hover-color);
        }

        /* Enhanced dropdown styling for search results */
        .control-group select[size] {
            border-color: var(--primary-accent-color);
            box-shadow: 0 2px 8px rgba(13, 153, 255, 0.2);
        }
        
        .control-group select option {
            padding: 5px;
            background-color: var(--input-bg-color);
            color: var(--primary-text-color);
        }
        
        .control-group select option:hover {
            background-color: var(--primary-accent-color);
            color: white;
        }

        #output {
            background-color: var(--input-bg-color);
            color: var(--secondary-text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--padding-base);
            font-size: var(--font-size-small);
            min-height: 60px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap; /* Allow wrapping */
            word-break: break-all;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <h1>Molecular Viewer</h1>
            
            <div class="control-group" id="moleculeInfoGroup">
                <h2>Molecule Information</h2>
                <p style="font-size: var(--font-size-small); margin-bottom: 4px;">Name: <span id="moleculeNameDisplay" style="color: var(--primary-text-color);">N/A</span></p>
                <p style="font-size: var(--font-size-small);">Formula: <span id="moleculeFormulaDisplay" style="color: var(--primary-text-color);">N/A</span></p>
            </div>
            
            <div class="control-group">
                <h2>Load Molecule</h2>
                <label for="moleculeSearch">Search molecules:</label>
                <input type="text" id="moleculeSearch" placeholder="Type to filter molecules..." style="margin-bottom: 10px;">
                
                <label for="moleculeLibrary">Quick Load from Library:</label>
                <select id="moleculeLibrary">
                    <option value="">-- Select a molecule --</option>
                    <optgroup label="Simple Molecules">
                        <option value="water">Water (H‚ÇÇO)</option>
                        <option value="methane">Methane (CH‚ÇÑ)</option>
                        <option value="ammonia">Ammonia (NH‚ÇÉ)</option>
                        <option value="carbon_dioxide">Carbon Dioxide (CO‚ÇÇ)</option>
                    </optgroup>
                    <optgroup label="Organic Molecules">
                        <option value="ethanol">Ethanol (C‚ÇÇH‚ÇÜO)</option>
                        <option value="acetone">Acetone (C‚ÇÉH‚ÇÜO)</option>
                        <option value="benzene">Benzene (C‚ÇÜH‚ÇÜ)</option>
                        <option value="toluene">Toluene (C‚ÇáH‚Çà)</option>
                        <option value="acetonitrile">Acetonitrile (C‚ÇÇH‚ÇÉN)</option>
                    </optgroup>
                    <optgroup label="Biological">
                        <option value="caffeine">Caffeine (C‚ÇàH‚ÇÅ‚ÇÄN‚ÇÑO‚ÇÇ)</option>
                        <option value="aspirin">Aspirin (C‚ÇâH‚ÇàO‚ÇÑ)</option>
                        <option value="glucose">Glucose (C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ)</option>
                    </optgroup>
                    <optgroup label="Solvents">
                        <option value="chloroform">Chloroform (CHCl‚ÇÉ)</option>
                        <option value="dmso">DMSO (C‚ÇÇH‚ÇÜOS)</option>
                        <option value="thf">THF (C‚ÇÑH‚ÇàO)</option>
                        <option value="ethyl_acetate">Ethyl Acetate (C‚ÇÑH‚ÇàO‚ÇÇ)</option>
                        <option value="dichloromethane">Dichloromethane (CH‚ÇÇCl‚ÇÇ)</option>
                        <option value="hexane">Hexane (C‚ÇÜH‚ÇÅ‚ÇÑ)</option>
                    </optgroup>
                    <optgroup label="Amino Acids">
                        <option value="glycine">Glycine (C‚ÇÇH‚ÇÖNO‚ÇÇ)</option>
                        <option value="alanine">Alanine (C‚ÇÉH‚ÇáNO‚ÇÇ)</option>
                    </optgroup>
                    <optgroup label="Inorganic">
                        <option value="hydrogen_peroxide">Hydrogen Peroxide (H‚ÇÇO‚ÇÇ)</option>
                        <option value="sulfur_dioxide">Sulfur Dioxide (SO‚ÇÇ)</option>
                        <option value="nitric_oxide">Nitric Oxide (NO)</option>
                    </optgroup>
                    <optgroup label="Pharmaceuticals">
                        <option value="ibuprofen">Ibuprofen (C‚ÇÅ‚ÇÉH‚ÇÅ‚ÇàO‚ÇÇ)</option>
                        <option value="paracetamol">Paracetamol (C‚ÇàH‚ÇâNO‚ÇÇ)</option>
                    </optgroup>
                </select>
                <button id="loadFromLibrary">Load Selected Molecule</button>
                <button id="loadRandomMolecule" style="margin-top: 5px;">Load Random Molecule</button>
                
                <label for="xyzData">Or paste XYZ data:</label>
                <textarea id="xyzData" placeholder="Paste XYZ data here..."></textarea>
            </div>

            <div class="control-group">
                <label for="xyzFilePicker">Or load from .xyz file:</label>
                <input type="file" id="xyzFilePicker" accept=".xyz">
            </div>

            <div class="control-group">
                <h2>Display Style</h2>
                <label for="representationSelect">Representation:</label>
                <select id="representationSelect">
                    <option value="0" selected>Ball and Stick</option>
                    <option value="1">Space Fill</option>
                    <option value="2">Licorice</option> 
                </select>
            </div>

            <div class="control-group">
                <h2>Appearance Controls</h2>
                <div>
                    <label for="zoomSlider">Zoom Level: <span id="zoomValue">1.00</span></label>
                    <input type="range" id="zoomSlider" min="0.1" max="5.0" value="1.0" step="0.1" style="width: 100%;">
                </div>
                <div style="margin-top: 10px;">
                    <label for="atomScaleSlider">Atom Size Scale: <span id="atomScaleValue">0.65</span></label>
                    <input type="range" id="atomScaleSlider" min="0.1" max="3.0" value="0.65" step="0.05" style="width: 100%;">
                </div>
                <div style="margin-top: 10px;">
                    <label for="bondRadiusSlider">Bond Radius: <span id="bondRadiusValue">0.10</span></label>
                    <input type="range" id="bondRadiusSlider" min="0.01" max="0.5" value="0.10" step="0.01" style="width: 100%;">
                </div>
                <div style="margin-top: 15px;">
                    <button id="autoRotateToggle" style="width: 100%;">üîÑ Start Auto-Rotate</button>
                </div>
            </div>

            <div class="control-group">
                <h2>Console Output</h2>
                <pre id="output"></pre>
            </div>
        </aside>

        <main class="main-content">
            <canvas id="canvas" width="800" height="600"></canvas> <!-- Initial size, can be adjusted by JS -->
        </main>
    </div>

    <script>
        // Molecule Library - XYZ coordinates for common molecules
        const MOLECULE_LIBRARY = {
            water: {
                name: "Water",
                formula: "H‚ÇÇO",
                xyz: `3
Water molecule
O    0.000000    0.000000    0.119262
H    0.000000    0.757570   -0.477047
H    0.000000   -0.757570   -0.477047`
            },
            methane: {
                name: "Methane", 
                formula: "CH‚ÇÑ",
                xyz: `5
Methane molecule
C    0.000000    0.000000    0.000000
H    0.629118    0.629118    0.629118
H   -0.629118   -0.629118    0.629118
H   -0.629118    0.629118   -0.629118
H    0.629118   -0.629118   -0.629118`
            },
            ammonia: {
                name: "Ammonia",
                formula: "NH‚ÇÉ", 
                xyz: `4
Ammonia molecule
N    0.000000    0.000000    0.112985
H    0.000000    0.937100   -0.263631
H    0.811441   -0.468550   -0.263631
H   -0.811441   -0.468550   -0.263631`
            },
            carbon_dioxide: {
                name: "Carbon Dioxide",
                formula: "CO‚ÇÇ",
                xyz: `3
Carbon dioxide molecule
C    0.000000    0.000000    0.000000
O    0.000000    0.000000    1.162323
O    0.000000    0.000000   -1.162323`
            },
            ethanol: {
                name: "Ethanol",
                formula: "C‚ÇÇH‚ÇÜO",
                xyz: `9
Ethanol molecule
C   -0.748380   -0.015520    0.024370
C    0.716990    0.026040   -0.061040
O    1.165720    1.232210    0.445470
H   -1.166000   -0.563000   -0.818200
H   -1.115510   -0.449650    0.962500
H   -1.115510    1.017350    0.024370
H    1.115510   -0.808200   -0.563000
H    1.115510    0.026040   -1.115510
H    2.115510    1.232210    0.445470`
            },
            acetone: {
                name: "Acetone",
                formula: "C‚ÇÉH‚ÇÜO",
                xyz: `10
Acetone molecule
C    0.000000    0.000000    0.000000
C    1.507000    0.000000    0.000000
C   -0.753500   -1.305000    0.000000
O   -0.753500    1.305000    0.000000
H    1.880500   -0.522500   -0.904500
H    1.880500   -0.522500    0.904500
H    1.880500    1.045000    0.000000
H   -0.427000   -1.827500   -0.904500
H   -0.427000   -1.827500    0.904500
H   -1.834500   -1.305000    0.000000`
            },
            benzene: {
                name: "Benzene",
                formula: "C‚ÇÜH‚ÇÜ",
                xyz: `12
Benzene molecule
C    1.396000    0.000000    0.000000
C    0.698000    1.209000    0.000000
C   -0.698000    1.209000    0.000000
C   -1.396000    0.000000    0.000000
C   -0.698000   -1.209000    0.000000
C    0.698000   -1.209000    0.000000
H    2.485000    0.000000    0.000000
H    1.242500    2.152000    0.000000
H   -1.242500    2.152000    0.000000
H   -2.485000    0.000000    0.000000
H   -1.242500   -2.152000    0.000000
H    1.242500   -2.152000    0.000000`
            },
            toluene: {
                name: "Toluene",
                formula: "C‚ÇáH‚Çà",
                xyz: `15
Toluene molecule
C    0.000000    0.000000    0.000000
C    1.396000    0.000000    0.000000
C    2.094000    1.209000    0.000000
C    1.396000    2.418000    0.000000
C    0.000000    2.418000    0.000000
C   -0.698000    1.209000    0.000000
C   -0.698000   -1.396000    0.000000
H    1.943000   -0.943000    0.000000
H    3.183000    1.209000    0.000000
H    1.943000    3.361000    0.000000
H   -0.547000    3.361000    0.000000
H   -1.787000    1.209000    0.000000
H   -0.174000   -2.339000    0.000000
H   -1.787000   -1.396000    0.000000
H   -0.174000   -1.396000    0.943000`
            },
            acetonitrile: {
                name: "Acetonitrile",
                formula: "C‚ÇÇH‚ÇÉN",
                xyz: `6
Acetonitrile molecule
C    0.000000    0.000000    0.000000
C    0.000000    0.000000    1.458000
N    0.000000    0.000000    2.620000
H    1.028000    0.000000   -0.381000
H   -0.514000   -0.890000   -0.381000
H   -0.514000    0.890000   -0.381000`
            },
            caffeine: {
                name: "Caffeine",
                formula: "C‚ÇàH‚ÇÅ‚ÇÄN‚ÇÑO‚ÇÇ",
                xyz: `24
Caffeine molecule
N   -1.274000   -0.226000    0.000000
C   -0.890000    1.067000    0.000000
N    0.408000    1.067000    0.000000
C    0.792000   -0.226000    0.000000
C   -0.274000   -1.067000    0.000000
C    2.158000   -0.226000    0.000000
O    2.792000   -1.274000    0.000000
N    2.792000    0.890000    0.000000
C    2.158000    2.158000    0.000000
N    0.890000    2.158000    0.000000
C   -2.658000   -0.658000    0.000000
C    4.226000    0.890000    0.000000
O   -0.658000   -2.274000    0.000000
H   -1.524000    1.931000    0.000000
H    2.792000    3.022000    0.000000
H    0.408000    3.022000    0.000000
H   -3.022000   -0.274000    0.890000
H   -3.022000   -0.274000   -0.890000
H   -2.658000   -1.750000    0.000000
H    4.590000    0.408000    0.890000
H    4.590000    0.408000   -0.890000
H    4.590000    1.931000    0.000000`
            },
            aspirin: {
                name: "Aspirin",
                formula: "C‚ÇâH‚ÇàO‚ÇÑ",
                xyz: `21
Aspirin molecule
C    0.000000    0.000000    0.000000
C    1.396000    0.000000    0.000000
C    2.094000    1.209000    0.000000
C    1.396000    2.418000    0.000000
C    0.000000    2.418000    0.000000
C   -0.698000    1.209000    0.000000
C   -0.698000   -1.396000    0.000000
O   -2.094000   -1.396000    0.000000
C   -2.792000   -2.605000    0.000000
O   -4.018000   -2.605000    0.000000
C    3.490000    1.209000    0.000000
O    3.490000    2.605000    0.000000
O    4.716000    0.513000    0.000000
H    1.943000   -0.943000    0.000000
H    1.943000    3.361000    0.000000
H   -0.547000    3.361000    0.000000
H   -1.787000    1.209000    0.000000
H   -0.174000   -2.339000    0.000000
H   -2.268000   -3.548000    0.000000
H    4.433000    2.605000    0.000000`
            },
            glucose: {
                name: "Glucose",
                formula: "C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ",
                xyz: `24
Glucose molecule
C    0.000000    0.000000    0.000000
C    1.396000    0.000000    0.000000
C    2.094000    1.209000    0.000000
C    1.396000    2.418000    0.000000
C    0.000000    2.418000    0.000000
O   -0.698000    1.209000    0.000000
O   -0.698000   -1.209000    0.000000
O    2.094000   -1.209000    0.000000
O    3.490000    1.209000    0.000000
O    2.094000    3.627000    0.000000
O   -0.698000    3.627000    0.000000
H    0.000000    0.000000    1.089000
H    1.396000    0.000000    1.089000
H    2.094000    1.209000    1.089000
H    1.396000    2.418000    1.089000
H    0.000000    2.418000    1.089000
H   -1.658000   -1.209000    0.000000
H    3.054000   -1.209000    0.000000
H    4.450000    1.209000    0.000000
H    3.054000    3.627000    0.000000
H   -1.658000    3.627000    0.000000`
            },
            chloroform: {
                name: "Chloroform",
                formula: "CHCl‚ÇÉ",
                xyz: `5
Chloroform molecule
C    0.000000    0.000000    0.000000
Cl   0.000000    0.000000    1.776000
Cl   1.676000   -0.968000   -0.592000
Cl  -1.676000   -0.968000   -0.592000
H    0.000000    1.936000   -0.592000`
            },
            dmso: {
                name: "DMSO",
                formula: "C‚ÇÇH‚ÇÜOS",
                xyz: `10
DMSO molecule
S    0.000000    0.000000    0.000000
O    0.000000    0.000000    1.504000
C    1.813000    0.000000   -0.752000
C   -1.813000    0.000000   -0.752000
H    1.813000    0.890000   -1.376000
H    1.813000   -0.890000   -1.376000
H    2.703000    0.000000   -0.128000
H   -1.813000   -0.890000   -1.376000
H   -1.813000    0.890000   -1.376000
H   -2.703000    0.000000   -0.128000`
            },
            thf: {
                name: "THF",
                formula: "C‚ÇÑH‚ÇàO",
                xyz: `13
THF molecule
O    0.000000    0.000000    0.000000
C    1.396000    0.000000    0.000000
C    2.094000    1.396000    0.000000
C    1.396000    2.094000    1.396000
C    0.000000    1.396000    1.396000
H    1.396000    0.000000   -1.089000
H    1.396000   -1.089000    0.000000
H    3.183000    1.396000    0.000000
H    2.094000    1.396000   -1.089000
H    1.396000    3.183000    1.396000
H    1.396000    2.094000    2.485000
H   -1.089000    1.396000    1.396000
H    0.000000    1.396000    2.485000`
            },
            ethyl_acetate: {
                name: "Ethyl Acetate",
                formula: "C‚ÇÑH‚ÇàO‚ÇÇ",
                xyz: `14
Ethyl acetate molecule
C    0.000000    0.000000    0.000000
C    1.507000    0.000000    0.000000
O    2.205000    1.162000    0.000000
O    2.205000   -1.162000    0.000000
C    3.712000   -1.162000    0.000000
C    4.410000   -2.324000    0.000000
H   -0.373000   -0.522000   -0.904500
H   -0.373000   -0.522000    0.904500
H   -0.373000    1.045000    0.000000
H    4.085000   -0.640000   -0.904500
H    4.085000   -0.640000    0.904500
H    4.037000   -2.846000   -0.904500
H    4.037000   -2.846000    0.904500
H    5.499000   -2.324000    0.000000`
            },
            dichloromethane: {
                name: "Dichloromethane",
                formula: "CH‚ÇÇCl‚ÇÇ",
                xyz: `5
Dichloromethane molecule
C    0.000000    0.000000    0.000000
Cl   0.000000    0.000000    1.776000
Cl   0.000000    1.776000    0.000000
H    1.089000   -0.363000   -0.363000
H   -1.089000   -0.363000   -0.363000`
            },
            hexane: {
                name: "Hexane",
                formula: "C‚ÇÜH‚ÇÅ‚ÇÑ",
                xyz: `20
Hexane molecule
C    0.000000    0.000000    0.000000
C    1.507000    0.000000    0.000000
C    2.205000    1.396000    0.000000
C    3.712000    1.396000    0.000000
C    4.410000    2.792000    0.000000
C    5.917000    2.792000    0.000000
H   -0.373000   -0.522000   -0.904500
H   -0.373000   -0.522000    0.904500
H   -0.373000    1.045000    0.000000
H    1.880000   -0.522000   -0.904500
H    1.880000   -0.522000    0.904500
H    1.832000    1.918000   -0.904500
H    1.832000    1.918000    0.904500
H    4.085000    0.874000   -0.904500
H    4.085000    0.874000    0.904500
H    4.037000    3.314000   -0.904500
H    4.037000    3.314000    0.904500
H    6.290000    2.270000   -0.904500
H    6.290000    2.270000    0.904500
H    6.290000    3.837000    0.000000`
            },
            glycine: {
                name: "Glycine",
                formula: "C‚ÇÇH‚ÇÖNO‚ÇÇ",
                xyz: `10
Glycine molecule
C    0.000000    0.000000    0.000000
C    1.507000    0.000000    0.000000
O    2.205000    1.162000    0.000000
O    2.205000   -1.162000    0.000000
N   -0.698000    1.396000    0.000000
H   -0.373000   -0.522000   -0.904500
H   -0.373000   -0.522000    0.904500
H   -0.325000    1.918000   -0.827000
H   -0.325000    1.918000    0.827000
H    3.165000   -1.162000    0.000000`
            },
            alanine: {
                name: "Alanine",
                formula: "C‚ÇÉH‚ÇáNO‚ÇÇ",
                xyz: `13
Alanine molecule
C    0.000000    0.000000    0.000000
C    1.507000    0.000000    0.000000
C   -0.698000    1.396000    0.000000
O    2.205000    1.162000    0.000000
O    2.205000   -1.162000    0.000000
N   -0.698000   -1.396000    0.000000
H   -0.373000   -0.522000   -0.904500
H   -0.325000    1.918000   -0.904500
H   -0.325000    1.918000    0.904500
H   -1.787000    1.396000    0.000000
H   -0.325000   -1.918000   -0.827000
H   -0.325000   -1.918000    0.827000
H    3.165000   -1.162000    0.000000`
            },
            hydrogen_peroxide: {
                name: "Hydrogen Peroxide",
                formula: "H‚ÇÇO‚ÇÇ",
                xyz: `4
Hydrogen peroxide molecule
O    0.000000    0.000000    0.000000
O    1.452000    0.000000    0.000000
H   -0.363000    0.890000    0.000000
H    1.815000   -0.890000    0.000000`
            },
            sulfur_dioxide: {
                name: "Sulfur Dioxide",
                formula: "SO‚ÇÇ",
                xyz: `3
Sulfur dioxide molecule
S    0.000000    0.000000    0.000000
O    0.000000    0.000000    1.481000
O    0.000000    1.481000   -0.741000`
            },
            nitric_oxide: {
                name: "Nitric Oxide",
                formula: "NO",
                xyz: `2
Nitric oxide molecule
N    0.000000    0.000000    0.000000
O    0.000000    0.000000    1.151000`
            },
            ibuprofen: {
                name: "Ibuprofen",
                formula: "C‚ÇÅ‚ÇÉH‚ÇÅ‚ÇàO‚ÇÇ",
                xyz: `33
Ibuprofen molecule
C    0.000000    0.000000    0.000000
C    1.396000    0.000000    0.000000
C    2.094000    1.209000    0.000000
C    1.396000    2.418000    0.000000
C    0.000000    2.418000    0.000000
C   -0.698000    1.209000    0.000000
C   -0.698000   -1.396000    0.000000
C   -2.094000   -1.396000    0.000000
C   -2.792000   -2.605000    0.000000
O   -4.018000   -2.605000    0.000000
O   -2.268000   -3.548000    0.000000
C    3.490000    1.209000    0.000000
C    4.188000    2.418000    0.000000
H    1.943000   -0.943000    0.000000
H    1.943000    3.361000    0.000000
H   -0.547000    3.361000    0.000000
H   -1.787000    1.209000    0.000000
H   -0.174000   -2.339000    0.000000
H   -2.618000   -0.452000    0.000000
H   -1.570000   -0.452000    0.000000
H    3.966000    0.265000    0.000000
H    3.966000    2.153000    0.000000
H    3.714000    3.362000    0.000000
H    4.662000    2.418000    0.890000
H    4.662000    2.418000   -0.890000
H   -4.542000   -3.548000    0.000000
C    0.698000   -2.605000    0.000000
C    1.396000   -3.814000    0.000000
H    0.174000   -2.605000    0.890000
H    0.174000   -2.605000   -0.890000
H    1.920000   -3.814000    0.890000
H    1.920000   -3.814000   -0.890000
H    0.872000   -4.757000    0.000000`
            },
            paracetamol: {
                name: "Paracetamol",
                formula: "C‚ÇàH‚ÇâNO‚ÇÇ",
                xyz: `20
Paracetamol molecule
C    0.000000    0.000000    0.000000
C    1.396000    0.000000    0.000000
C    2.094000    1.209000    0.000000
C    1.396000    2.418000    0.000000
C    0.000000    2.418000    0.000000
C   -0.698000    1.209000    0.000000
O   -0.698000   -1.209000    0.000000
N    3.490000    1.209000    0.000000
C    4.188000    2.418000    0.000000
O    5.414000    2.418000    0.000000
C    3.490000   -0.187000    0.000000
H    1.943000   -0.943000    0.000000
H    1.943000    3.361000    0.000000
H   -0.547000    3.361000    0.000000
H   -1.787000    1.209000    0.000000
H   -1.658000   -1.209000    0.000000
H    4.014000    0.756000    0.000000
H    3.966000   -0.131000    0.890000
H    3.966000   -0.131000   -0.890000
H    3.714000    3.362000    0.000000`
            }
        };

        var Module = {
            preRun: [],
            postRun: [],
            print: (function() {
                var element = document.getElementById('output');
                if (element) element.innerHTML = ''; 
                return function(text) {
                    if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                    console.log(text);
                    if (element) {
                        element.innerHTML += text + "\n";
                        element.scrollTop = element.scrollHeight; // Auto-scroll
                    }
                };
            })(),
            printErr: function(text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                console.error(text);
                var element = document.getElementById('output');
                if (element) {
                    element.innerHTML += "<span style='color: var(--danger-color);'>" + text + "</span>\n";
                    element.scrollTop = element.scrollHeight; // Auto-scroll
                }
            },
            canvas: (function() {
                var canvas = document.getElementById('canvas');
                canvas.addEventListener("webglcontextlost", function(e) { 
                    alert('WebGL context lost. You will need to reload the page.'); 
                    e.preventDefault(); 
                }, false);
                return canvas;
            })(),
            setStatus: function(text) {
                if (text) Module.printErr("[STATUS] " + text);
            },
            totalDependencies: 0,
            monitorRunDependencies: function(left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
            },
            onRuntimeInitialized: function() {
                console.log("Emscripten runtime initialized.");
                Module.print("App initialized. Ready to load molecule.");

                const moleculeNameSpan = document.getElementById('moleculeNameDisplay');
                const moleculeFormulaSpan = document.getElementById('moleculeFormulaDisplay');

                function updateMoleculeInfoDisplay() {
                    if (!Module.ccall || !moleculeNameSpan || !moleculeFormulaSpan) {
                        console.warn("Molecule info display elements or ccall not ready.");
                        if(moleculeNameSpan) moleculeNameSpan.textContent = "Error";
                        if(moleculeFormulaSpan) moleculeFormulaSpan.textContent = "Error";
                        return;
                    }
                    try {
                        const name = Module.ccall('get_current_molecule_name', 'string', [], []);
                        const formula = Module.ccall('get_current_molecule_formula', 'string', [], []);
                        moleculeNameSpan.textContent = name ? name : "N/A";
                        moleculeFormulaSpan.textContent = formula ? formula : "N/A";
                    } catch (e) {
                        Module.printErr("Error fetching molecule info: " + e);
                        moleculeNameSpan.textContent = "Error";
                        moleculeFormulaSpan.textContent = "Error";
                    }
                }

                // Initial update for sample molecule (if any is loaded by default)
                updateMoleculeInfoDisplay(); 

                // Setup molecule search functionality
                const moleculeSearch = document.getElementById('moleculeSearch');
                const moleculeLibrary = document.getElementById('moleculeLibrary');
                const allOptions = Array.from(moleculeLibrary.querySelectorAll('option, optgroup'));
                
                if (moleculeSearch && moleculeLibrary) {
                    moleculeSearch.addEventListener('input', function(event) {
                        const searchTerm = event.target.value.toLowerCase();
                        
                        // Reset all options to visible
                        allOptions.forEach(element => {
                            element.style.display = '';
                        });
                        
                        if (searchTerm) {
                            // Automatically expand the dropdown when searching
                            moleculeLibrary.size = Math.min(10, moleculeLibrary.options.length);
                            moleculeLibrary.style.height = 'auto';
                            
                            let visibleCount = 0;
                            
                            // Hide options that don't match
                            allOptions.forEach(element => {
                                if (element.tagName === 'OPTION' && element.value) {
                                    const optionText = element.textContent.toLowerCase();
                                    const moleculeData = MOLECULE_LIBRARY[element.value];
                                    const moleculeName = moleculeData ? moleculeData.name.toLowerCase() : '';
                                    const moleculeFormula = moleculeData ? moleculeData.formula.toLowerCase() : '';
                                    
                                    if (!optionText.includes(searchTerm) && 
                                        !moleculeName.includes(searchTerm) && 
                                        !moleculeFormula.includes(searchTerm)) {
                                        element.style.display = 'none';
                                    } else {
                                        visibleCount++;
                                    }
                                }
                            });
                            
                            // Hide empty optgroups
                            allOptions.forEach(element => {
                                if (element.tagName === 'OPTGROUP') {
                                    const visibleOptions = Array.from(element.querySelectorAll('option')).filter(opt => opt.style.display !== 'none');
                                    if (visibleOptions.length === 0) {
                                        element.style.display = 'none';
                                    }
                                }
                            });
                            
                            // Adjust dropdown size based on visible results
                            moleculeLibrary.size = Math.min(Math.max(3, visibleCount + 2), 10);
                            
                        } else {
                            // Reset to normal dropdown when search is cleared
                            moleculeLibrary.size = 1;
                            moleculeLibrary.style.height = '';
                        }
                    });
                    
                    // Also expand dropdown when clicking on search field
                    moleculeSearch.addEventListener('focus', function(event) {
                        if (event.target.value.trim()) {
                            moleculeLibrary.size = Math.min(10, moleculeLibrary.options.length);
                        }
                    });
                    
                    // Collapse dropdown when clicking elsewhere
                    document.addEventListener('click', function(event) {
                        if (!moleculeSearch.contains(event.target) && !moleculeLibrary.contains(event.target)) {
                            if (!moleculeSearch.value.trim()) {
                                moleculeLibrary.size = 1;
                                moleculeLibrary.style.height = '';
                            }
                        }
                    });
                }

                // Setup representation select listener
                const representationSelect = document.getElementById('representationSelect');
                if (representationSelect) {
                    representationSelect.addEventListener('change', function(event) {
                        const repValue = parseInt(event.target.value);
                        if (Module.ccall) { // Check if ccall is available
                            try {
                                Module.ccall('set_representation', // C function name
                                             null,                 // Return type
                                             ['number'],           // Argument types
                                             [repValue]);          // Arguments
                                Module.print(`Representation set to: ${event.target.options[event.target.selectedIndex].text}`);
                            } catch (e) {
                                Module.printErr("Error calling set_representation: " + e);
                            }
                        } else {
                            Module.printErr("Module.ccall is not available. Ensure set_representation is exported.");
                        }
                    });
                } else {
                    Module.printErr("Could not find representationSelect element.");
                }

                // Setup Appearance Controls listeners
                const atomScaleSlider = document.getElementById('atomScaleSlider');
                const atomScaleValueSpan = document.getElementById('atomScaleValue');
                const bondRadiusSlider = document.getElementById('bondRadiusSlider');
                const bondRadiusValueSpan = document.getElementById('bondRadiusValue');
                const zoomSlider = document.getElementById('zoomSlider');
                const zoomValueSpan = document.getElementById('zoomValue');

                if (atomScaleSlider && atomScaleValueSpan) {
                    atomScaleSlider.addEventListener('input', function(event) {
                        const scale = parseFloat(event.target.value);
                        atomScaleValueSpan.textContent = scale.toFixed(2);
                        if (Module.ccall) {
                            try {
                                Module.ccall('set_atom_display_scale', null, ['number'], [scale]);
                            } catch (e) { Module.printErr("Error calling set_atom_display_scale: " + e); }
                        }
                    });
                } else {
                    Module.printErr("Could not find atom scale slider elements.");
                }

                if (bondRadiusSlider && bondRadiusValueSpan) {
                    bondRadiusSlider.addEventListener('input', function(event) {
                        const radius = parseFloat(event.target.value);
                        bondRadiusValueSpan.textContent = radius.toFixed(2);
                        if (Module.ccall) {
                            try {
                                Module.ccall('set_bond_radius_value', null, ['number'], [radius]);
                            } catch (e) { Module.printErr("Error calling set_bond_radius_value: " + e); }
                        }
                    });
                } else {
                    Module.printErr("Could not find bond radius slider elements.");
                }

                if (zoomSlider && zoomValueSpan) {
                    zoomSlider.addEventListener('input', function(event) {
                        const zoom = parseFloat(event.target.value);
                        zoomValueSpan.textContent = zoom.toFixed(2);
                        if (Module.ccall) {
                            try {
                                Module.ccall('set_zoom_level', null, ['number'], [zoom]);
                            } catch (e) { Module.printErr("Error calling set_zoom_level: " + e); }
                        }
                    });
                } else {
                    Module.printErr("Could not find zoom slider elements.");
                }

                // Setup auto-rotate toggle functionality
                const autoRotateToggle = document.getElementById('autoRotateToggle');
                let isAutoRotating = false;
                
                if (autoRotateToggle) {
                    autoRotateToggle.addEventListener('click', function() {
                        isAutoRotating = !isAutoRotating;
                        
                        if (isAutoRotating) {
                            autoRotateToggle.textContent = '‚è∏Ô∏è Stop Auto-Rotate';
                            autoRotateToggle.style.backgroundColor = 'var(--danger-color)';
                            if (Module.ccall) {
                                try {
                                    Module.ccall('set_auto_rotate', null, ['number'], [1]);
                                    Module.print("Auto-rotation started");
                                } catch (e) { Module.printErr("Error calling set_auto_rotate: " + e); }
                            }
                        } else {
                            autoRotateToggle.textContent = 'üîÑ Start Auto-Rotate';
                            autoRotateToggle.style.backgroundColor = 'var(--primary-accent-color)';
                            if (Module.ccall) {
                                try {
                                    Module.ccall('set_auto_rotate', null, ['number'], [0]);
                                    Module.print("Auto-rotation stopped");
                                } catch (e) { Module.printErr("Error calling set_auto_rotate: " + e); }
                            }
                        }
                    });
                } else {
                    Module.printErr("Could not find auto-rotate toggle button.");
                }

                // Adjust canvas size to fit main content area
                const mainContent = document.querySelector('.main-content');
                const canvas = Module.canvas;
                function resizeCanvas() {
                    const dpr = window.devicePixelRatio || 1;
                    const newCssWidth = mainContent.clientWidth;
                    const newCssHeight = mainContent.clientHeight;

                    const newBufferWidth = Math.round(newCssWidth * dpr);
                    const newBufferHeight = Math.round(newCssHeight * dpr);

                    canvas.width = newBufferWidth;
                    canvas.height = newBufferHeight;
                    canvas.style.width = newCssWidth + 'px';
                    canvas.style.height = newCssHeight + 'px';
                    
                    // Enhanced logging
                    console.log(`[resizeCanvas] Event. CSS Dimensions: ${newCssWidth}w x ${newCssHeight}h. DPR: ${dpr}.`);
                    console.log(`[resizeCanvas] Calculated Buffer: ${newBufferWidth}w x ${newBufferHeight}h.`);
                    console.log(`[resizeCanvas] Set canvas.width=${canvas.width}, canvas.height=${canvas.height}.`);
                    console.log(`[resizeCanvas] Set canvas.style.width='${canvas.style.width}', canvas.style.height='${canvas.style.height}'.`);

                    if (Module.ccall) {
                        try {
                           Module.ccall('update_projection_matrix_aspect', 
                                        null, 
                                        ['number', 'number'], 
                                        [canvas.width, canvas.height]); // Pass the actual buffer width and height
                            console.log(`[resizeCanvas] Called C++ update_projection_matrix_aspect(${canvas.width}, ${canvas.height}).`);
                        } catch (e) {
                            console.warn("[resizeCanvas] Error calling C++ update_projection_matrix_aspect:", e);
                        }
                    } else {
                        console.warn("[resizeCanvas] Module.ccall not available or C++ function update_projection_matrix_aspect not ready.");
                    }
                }
                
                // Initial resize, delayed slightly to allow layout to stabilize
                setTimeout(function() {
                    console.log("[onRuntimeInitialized] Calling initial resizeCanvas after timeout.");
                    resizeCanvas(); 
                }, 100); 

                window.addEventListener('resize', resizeCanvas); // Resize on window change

                function call_cpp_load_molecule(xyzText) {
                    if (xyzText.trim() === "") {
                        Module.printErr("No XYZ data to load.");
                        // Clear info if no data
                        if(moleculeNameSpan) moleculeNameSpan.textContent = "N/A";
                        if(moleculeFormulaSpan) moleculeFormulaSpan.textContent = "N/A";
                        return;
                    }
                    try {
                        Module.ccall(
                            'load_molecule_from_xyz_string',
                            null, 
                            ['string'],
                            [xyzText]
                        );
                        Module.print("JS: Called C++ to load molecule.");
                        updateMoleculeInfoDisplay(); // Update info after loading
                    } catch (e) {
                        console.error("JS: Error calling C++ function:", e);
                        Module.printErr("Error calling C++ load function. See console.");
                        if(moleculeNameSpan) moleculeNameSpan.textContent = "Error loading name";
                        if(moleculeFormulaSpan) moleculeFormulaSpan.textContent = "Error loading formula";
                    }
                }

                document.getElementById('loadFromLibrary').addEventListener('click', function() {
                    const selectedMolecule = document.getElementById('moleculeLibrary').value;
                    if (selectedMolecule && MOLECULE_LIBRARY[selectedMolecule]) {
                        const moleculeData = MOLECULE_LIBRARY[selectedMolecule];
                        document.getElementById('xyzData').value = moleculeData.xyz;
                        call_cpp_load_molecule(moleculeData.xyz);
                        Module.print(`Loaded ${moleculeData.name} (${moleculeData.formula}) from library.`);
                    } else {
                        Module.printErr("No molecule selected or molecule not found in library.");
                    }
                });

                document.getElementById('loadRandomMolecule').addEventListener('click', function() {
                    const moleculeKeys = Object.keys(MOLECULE_LIBRARY);
                    if (moleculeKeys.length > 0) {
                        const randomKey = moleculeKeys[Math.floor(Math.random() * moleculeKeys.length)];
                        const moleculeData = MOLECULE_LIBRARY[randomKey];
                        
                        // Update the dropdown selection
                        document.getElementById('moleculeLibrary').value = randomKey;
                        
                        // Load the molecule
                        document.getElementById('xyzData').value = moleculeData.xyz;
                        call_cpp_load_molecule(moleculeData.xyz);
                        Module.print(`Randomly loaded ${moleculeData.name} (${moleculeData.formula}) from library.`);
                    } else {
                        Module.printErr("No molecules available in library.");
                    }
                });

                document.getElementById('xyzFilePicker').addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const fileContent = e.target.result;
                            document.getElementById('xyzData').value = fileContent; 
                            call_cpp_load_molecule(fileContent);
                        };
                        reader.onerror = function(e) {
                            console.error("File reading error:", e);
                            Module.printErr("Error reading file.");
                        };
                        reader.readAsText(file);
                    } else {
                        Module.print("No file selected for upload.");
                    }
                });
            }
        };
        window.onerror = function(message, source, lineno, colno, error) {
            Module.printErr("JS Global Error: " + message + " at " + source + ":" + lineno);
            return true; // Prevents the browser's default error handling
        };
    </script>
    <script async src="main.js"></script>
</body>
</html> 